I"Ù@<!-- Description Guidelines

Please note:
Use the full links to reference other files or images! Relative links will not work under our theme settings settings.
-->

<!-- please choose the appropriate batch and delete/comment the others  -->
<p><img src="https://img.shields.io/badge/Status-Production-brightgreen.svg" alt="prod" /></p>

<h1 id="integration-layer-service-ils-"><strong>Integration Layer Service (ILS)</strong> <!-- make sure spelling is consistent with other sources and within this document --></h1>

<h2 id="introduction">Introduction</h2>
<!-- 2 sentences: what does it do and how -->

<p>The Integration Layer Service receives data objects from one or several incoming flows, applies some business logic (such as a merge or split), validates them against a supplied schema, and provides the resulting valid objects as input to other flows. ILS can temporarily store these objects. Objects can be posted to the ILS through a REST-API, and be retrieved the same way.</p>

<p><a href="http://ils.openintegrationhub.com/api-docs/" class="btn fs-5 mb-4 mb-md-0">API Reference</a>
<a href="https://github.com/openintegrationhub/openintegrationhub/tree/master/services/ils" class="btn fs-5 mb-4 mb-md-0">Implementation</a>
<!--[Service File](){: .btn .fs-5 .mb-4 .mb-md-0 }--></p>

<h2 id="technologies-used">Technologies used</h2>
<!-- please name and elaborate on other technologies or standards the service uses -->
<p><a href="https://www.mongodb.com/">MongoDB</a>: MongoDB is used as the ILSâ€™s storage solution.</p>

<h2 id="how-it-works">How it works</h2>

<!-- describe core functionalities and underlying concepts in more detail -->

<h3 id="use-case-merging-objects">Use case: Merging objects</h3>
<p>A core functionality is merging of incomplete objects from separate sources until all required data has been added. For this purpose, all incoming POST requests must supply a <em>common identifier</em> (cid) by which incoming objects can be matched against each other. Each time a new object comes in, the ILS first looks up its database to check whether another object with a matching cid is already stored. If one is found, the new data is merged into the existing object. If not, the incoming object is saved as-is.</p>

<p>In either case, the resulting object is then validated against a supplied definition, which includes a list of required fields. A valid object will be marked as such, and can then be retrieved by another component. If an object is invalid, it cannot be retrieved, and will instead be stored until the necessary data has been merged into it and it passes validation.</p>

<h3 id="use-case-splitting-objects">Use case: Splitting objects</h3>
<p>ILS comes into play when the user would like to split an object into smaller or other objects containing properties from the main object. Letâ€™s say that the user want to split the object containing employeeâ€™s <code class="language-plaintext highlighter-rouge">firstName</code>, <code class="language-plaintext highlighter-rouge">lastName</code>, <code class="language-plaintext highlighter-rouge">salutation</code>, <code class="language-plaintext highlighter-rouge">organization</code>, <code class="language-plaintext highlighter-rouge">email</code>, <code class="language-plaintext highlighter-rouge">street</code> and <code class="language-plaintext highlighter-rouge">streetNumber</code> into two separate objects. The first one should have the properties <code class="language-plaintext highlighter-rouge">firstName</code>, <code class="language-plaintext highlighter-rouge">lastName</code>  and <code class="language-plaintext highlighter-rouge">salutation</code> ant the second one should contain the rest. In this case the user must provide <code class="language-plaintext highlighter-rouge">splitSchema</code> array containing two objects and each of them must have the properties <code class="language-plaintext highlighter-rouge">meta</code> and <code class="language-plaintext highlighter-rouge">payload</code>. Meta has the special property <code class="language-plaintext highlighter-rouge">splitKey</code> which servers as an identifier and <code class="language-plaintext highlighter-rouge">payload</code> consists of the fields which the new splitted object must contain. After successful splitting each new object should hold  the <code class="language-plaintext highlighter-rouge">splitKey</code> and <code class="language-plaintext highlighter-rouge">payload</code> properties.</p>

<p>On the other hand the user would like to <code class="language-plaintext highlighter-rouge">GET</code> a new/splitted object. In such a case an <code class="language-plaintext highlighter-rouge">ilaId</code> and a <code class="language-plaintext highlighter-rouge">splitKey</code> must be provided. Then ILS will return an array of all objects which have the same <code class="language-plaintext highlighter-rouge">splitKey</code>.</p>

<h3 id="use-case-validating-objects">Use case: Validating objects</h3>
<p>ILS is able to validate an object against a certain schema. This means that the incoming object could be validated against a custom schema, which the user can provide in <code class="language-plaintext highlighter-rouge">schema</code> object or the object could be validated against a schema which is already stored in <a href="https://openintegrationhub.github.io//docs/Services/MetaDataRepository.html">Meta Data Repository</a> as well. Then the user should provide an IAM <code class="language-plaintext highlighter-rouge">token</code>, <code class="language-plaintext highlighter-rouge">domainId</code> and <code class="language-plaintext highlighter-rouge">schemaUri</code>. The last two properties could be requested from <a href="https://openintegrationhub.github.io//docs/Services/MetaDataRepository.html">Meta Data Repository</a>.</p>

<h3 id="integration-layer-service-api">Integration Layer Service API</h3>

<p>The ILS offers a REST API through which chunks can be stored, splitted, validated and retrieved. To interact with this API, the user must supply a valid bearer token generated by the Identity Management.</p>

<h3 id="list-of-supported-methods-and-routes">List of supported Methods and Routes</h3>
<hr />

<table>
  <thead>
    <tr>
      <th>endpoint</th>
      <th style="text-align: center">method</th>
      <th>description</th>
      <th>comments</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>/chunks</td>
      <td style="text-align: center">POST</td>
      <td>Stores a new chunk</td>
      <td>Depending on validation result, the chunk is saved with a <strong>boolean</strong> value of the property <code class="language-plaintext highlighter-rouge">valid</code></td>
    </tr>
    <tr>
      <td>/chunks/split</td>
      <td style="text-align: center">POST</td>
      <td>Splits a chunk</td>
      <td>An incoming object is splitted in other objects depending on given criteria</td>
    </tr>
    <tr>
      <td>/chunks/validate</td>
      <td style="text-align: center">POST</td>
      <td>Validates a chunk</td>
      <td>The incoming object is validated against a schema from Meta Data Repository</td>
    </tr>
    <tr>
      <td>/chunks/{ilaId}?key={splitKey}</td>
      <td style="text-align: center">GET</td>
      <td>Returns chunks by <code class="language-plaintext highlighter-rouge">ilaId</code> and <code class="language-plaintext highlighter-rouge">splitKey</code>.</td>
      <td>SplitKey is on optional parameter for fetching chunks which are splitted by the same <code class="language-plaintext highlighter-rouge">splitSchema</code></td>
    </tr>
  </tbody>
</table>

<p>These operations ought to be conducted via the ILA, but can also be targeted manually for testing and development purposes.</p>

<p>For <code class="language-plaintext highlighter-rouge">POST /chunks</code>, the body format is expected to match this format:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"ilaId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"cid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"def"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nl">"payload"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ilaId</code>: Identifies which combination of flows this object belongs to. Must match among all connected flows.</li>
  <li><code class="language-plaintext highlighter-rouge">cid</code>: A <em>common identifier</em> designating which fields are used to match objects to one another. Must be a key within the supplied payload</li>
  <li><code class="language-plaintext highlighter-rouge">def</code>: The definition against which objects are validated. Currently expected to be a JSON schema.</li>
  <li><code class="language-plaintext highlighter-rouge">payload</code>: The actual data object, in JSON format.</li>
</ul>

<p>For <code class="language-plaintext highlighter-rouge">POST /chunks/split</code>, the body format should have the following format:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"ilaId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"payload"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
  </span><span class="nl">"splitSchema"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"splitKey"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"payload"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ilaId</code>: Identifies which combination of flows this object belongs to. Must match among all connected flows.</li>
  <li><code class="language-plaintext highlighter-rouge">payload</code>: The actual data object, in JSON format.</li>
  <li><code class="language-plaintext highlighter-rouge">splitSchema</code>: A schema object which could contain more then one schema. The main purpose is each schema has a meta object with an unique <code class="language-plaintext highlighter-rouge">splitKey</code>. This identifies the splitting model. In <code class="language-plaintext highlighter-rouge">payload</code> is the actual schema with all properties.</li>
</ul>

<p>For <code class="language-plaintext highlighter-rouge">POST /chunks/validate</code>, the body format should have the following format:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"ilaId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"token"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"cid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"def"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"domainId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"schemaUri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">

  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"payload"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ilaId</code>: Identifies which combination of flows this object belongs to. Must match among all connected flows.</li>
  <li><code class="language-plaintext highlighter-rouge">token</code>: An IAM Bearer token</li>
  <li><code class="language-plaintext highlighter-rouge">cid</code>: A <em>common identifier</em> designating which fields are used to match objects to one another. Must be a key within the supplied payload</li>
  <li><code class="language-plaintext highlighter-rouge">def</code>: The definition against which objects are validated. Currently expected to be a JSON schema.</li>
  <li><code class="language-plaintext highlighter-rouge">domainId</code> - A <code class="language-plaintext highlighter-rouge">domainId</code> from <a href="https://openintegrationhub.github.io//docs/Services/MetaDataRepository.html">Meta Data Repository</a></li>
  <li><code class="language-plaintext highlighter-rouge">schemaUri</code> - A <code class="language-plaintext highlighter-rouge">schemaUri</code> for a certain schema from <a href="https://openintegrationhub.github.io//docs/Services/MetaDataRepository.html">Meta Data Repository</a></li>
  <li><code class="language-plaintext highlighter-rouge">payload</code>: The actual data object, in JSON format.</li>
</ul>

<p>To <code class="language-plaintext highlighter-rouge">GET /chunks/${ilaId}</code>, an <code class="language-plaintext highlighter-rouge">ilaId</code> must be supplied. This will return all objects marked as valid that have been saved with this <code class="language-plaintext highlighter-rouge">ilaId</code>.</p>

<p>To <code class="language-plaintext highlighter-rouge">GET /chunks/${ilaId}?key=${splitKey}</code> the user should provide the <code class="language-plaintext highlighter-rouge">ilaId</code> and <code class="language-plaintext highlighter-rouge">key</code> as a parameter for fetching objects which are splitted by a <code class="language-plaintext highlighter-rouge">splitSchema</code> with the certain <code class="language-plaintext highlighter-rouge">splitKey</code>.</p>

<p>Stored objects are endowed with a Time To Live of one hour, which is refreshed every time new data is merged into them.</p>

<h3 id="integration-layer-adapter-ila">Integration Layer Adapter (ILA)</h3>
<p>The ILA is a generic component used to allow flows to communicate with the ILS. In posting mode, it automatically passes on any data objects received by other flow components, and endows them with the metadata listed above. In polling mode, it will automatically fetch all valid combined objects and pass them on to other components just like any other flow component. For further information about the ILA, see its <a href="https://github.com/openintegrationhub/integration-layer-adapter">GitHub Repository</a></p>

<h3 id="interaction-with-other-services">Interaction with other Services</h3>
<p>The Integration Layer Service interacts with this Service:</p>

<ul>
  <li><a href="https://openintegrationhub.github.io//docs/Services/MetaDataRepository.html">Meta Data Repository</a>: If the user wants to validate an object against a schema from <a href="https://openintegrationhub.github.io//docs/Services/MetaDataRepository.html">Meta Data Repository</a>, this schema must be fetched. For this purpose a bearer<code class="language-plaintext highlighter-rouge">token</code>, <code class="language-plaintext highlighter-rouge">domainId</code> and <code class="language-plaintext highlighter-rouge">schemaUri</code> must be provided.</li>
</ul>
:ET